TECHNICAL DESIGN DOCUMENT

Fitness-tracker-app

1\. OVERVIEW

\* \*\*Goal:\*\*  
    \* Provide users with safe and effective workout routines tailored to their specific age, BMI, diet, and pre-existing health conditions.  
    \* Eliminate the guesswork in fitness by generating personalized plans for achieving a healthy weight target.  
    \* Offer a single platform to track key fitness metrics (like weight and BMI) and visualize progress against personalized goals.

\* \*\*Key features:\*\*  
    \* \*\*Personalized Profile:\*\* A comprehensive onboarding flow to capture age, height, weight (for BMI calculation), current diet, known health conditions, and fitness goals (e.g., target healthy weight).  
    \* \*\*Dynamic Workout Generator:\*\* Creates customized, adaptive workout routines (e.g., weekly plans, daily exercises) based on the user's complete profile.  
    \* \*\*Progress Tracking Dashboard:\*\* Allows users to log completed workouts, track weight/BMI changes over time, and visualize their journey.  
    \* \*\*Routine Adaptation:\*\* The system will periodically suggest adjustments to the workout plan as the user's metrics (like BMI) change.

\* \*\*Target users & success criteria:\*\*  
    \* \*\*Target Users:\*\* Individuals (especially beginners or those with specific health concerns) who need a structured fitness plan that accounts for their unique health profile rather than a one-size-fits-all solution.  
    \* \*\*Success Criteria:\*\*  
        \* High user retention (\>30% after 90 days).  
        \* High onboarding completion rate (\>90%).  
        \* 75% of active users show measurable progress toward their goals (e.g., consistent workout logging, weight change) within 8 weeks.

\---

2\. TECH STACK (GOLDEN PATH)

Runtime:               Node (Firebase Gen 2 Cloud Functions)  
Language:              TypeScript (strict)  
Front-end:             React \+ Vite  
UI kit:                shadcn/ui (Radix \+ Tailwind source-copy model)  
Styling:               Tailwind CSS (design-token file)  
Forms & validation:    React Hook Form \+ Zod resolver  
Shared validation:     Zod (client & server)  
Backend services:      Firebase Auth · Firestore ·   
Package manager / mono: PNPM workspaces  
Build orchestration:   Turborepo (remote caching)  
Component workshop:    Storybook (UI in isolation)  
Unit / component tests: Vitest \+ Testing Library  
Visual / interaction:  Storybook \+ @storybook/testing-library  
End-to-end tests:      Playwright  
Linting:               ESLint (typescript-eslint) \+ eslint-plugin-perfectionist  
Formatting:            Prettier  
Type-safe env vars:    T3 Env (Zod-validated)  
Versioning / publishing: Changesets (monorepo changelogs & releases)  
CI / CD:               GitHub Actions (Turbo-aware pipeline; see §8)

\---

3\. MONOREPO LAYOUT (PNPM)

.  
├── apps/  
│   └── web/            ← React front-end (+ .storybook)        
├── packages/  
│   ├── shared/         ← Zod schemas, utilities, common types  
│   └── seeding/        ← Data-seeding helpers (Firestore emulator/Admin SDK)  
├── docs/               ← Project docs (this TDD, ADRs, API notes)  
└── .github/            ← CI workflows

\---

4\. ARCHITECTURE  
    Client (React \+ TanStack Query) ⇄ tRPC HTTPS endpoints (Cloud Functions)  
    tRPC handlers read/write Firestore documents and interact with Storage.

    This architecture provides a type-safe, serverless API layer, minimizing backend boilerplate and leveraging Firebase's managed services for authentication, database, and scalability.

\---

5\. DATA MODEL

| Entity | Key fields | Notes |  
| \--- | \--- | \--- |  
| User | uid, email, role, createdAt | Managed by Firebase Auth; root doc in Firestore \`users/{uid}\` |  
| Profile | age, heightCm, weightKg, healthConditions, dietaryPreference, fitnessGoal, updatedAt | Stored in subcollection: \`users/{uid}/profile/main\` |  
| WorkoutPlan | userId, startDate, endDate, status, dailyWorkouts (array) | Generated by a function. Collection: \`workoutPlans\` |  
| ActivityLog | userId, date, durationMinutes, type, workoutPlanId (optional) | Tracks user-completed activities. Collection: \`activityLogs\` |  
| Exercise | name, description, videoUrl, targetMuscles, difficulty, contraindications | Global collection of all possible exercises. Collection: \`exercises\` |

\* \*\*Security rules:\*\*  
    \* Users can only read/write documents within their \*own\* user path (e.g., \`users/{uid}/...\`).  
    \* \`users/{uid}/profile/main\` can be read/written only by the authenticated \`uid\`.  
    \* \`activityLogs\` and \`workoutPlans\` can be created/read by the matching \`userId\`.  
    \* The \`exercises\` collection is read-only for all authenticated users.  
    \* Cloud Functions (backend) will have admin-level access to write new \`workoutPlans\`.

\* \*\*Index strategy:\*\*  
    \* Composite index on \`activityLogs\` for \`userId\` and \`date\` (for progress charts).  
    \* Composite index on \`workoutPlans\` for \`userId\` and \`status\` (to find the 'active' plan).

\---

6\. API DESIGN (tRPC)

| Router | Procedure | Input (Zod schema) | Output |  
| \--- | \--- | \--- | \--- |  
| user | get | \`undefined\` | \`User\` (from \`ctx.auth\`) |  
| profile | get | \`undefined\` | \`ProfileSchema \\| null\` |  
| profile | update | \`ProfileSchema\` | \`ProfileSchema\` |  
| workout | getActivePlan | \`undefined\` | \`WorkoutPlanSchema \\| null\` |  
| workout | generatePlan | \`undefined\` (reads from user's Profile) | \`WorkoutPlanSchema\` (mutation) |  
| progress | logActivity | \`ActivityLogSchema\` | \`ActivityLogSchema\` (mutation) |  
| progress | getHistory | \`z.object({ range: z.enum(\['7d', '30d', '90d'\]) })\` | \`Array\<{ date: Date, weightKg: number }\>\` |

\* \*\*Error-handling conventions:\*\*  
    \* tRPC handles Zod validation errors automatically (sends \`BAD\_REQUEST\`).  
    \* Use \`UNAUTHORIZED\` if \`ctx.auth\` is missing for any protected procedure.  
    \* Use \`NOT\_FOUND\` if a user queries for a resource that doesn't exist (e.g., \`profile.get\` when one hasn't been created).  
    \* Use \`INTERNAL\_SERVER\_ERROR\` for unexpected failures (e.g., workout generation logic fails).

\---

7\. TESTING STRATEGY

| Level / focus | Toolset | Scope |  
| \--- | \--- | \--- |  
| Unit | Vitest | Pure functions (e.g., BMI calculator), Zod schemas, tRPC router logic (mocking \`ctx\`) |  
| Component | Vitest \+ Testing Library | React components (e.g., \`ProfileOnboardingForm\`) |  
| Visual / interaction | Storybook \+ @storybook/testing-library | UI snapshots, states (loading, error), and user interactions in isolation |  
| End-to-end | Playwright | Auth flow, profile completion, workout generation, logging an activity |

\* \*\*Coverage target:\*\* 80% statements.  
\* \*\*Fixtures / seeding:\*\* \`pnpm seed\` → runs scripts in \`packages/seeding\` against the Firebase emulator (e.g., to populate the \`exercises\` collection).

\---

8\. CI / CD PIPELINE (GITHUB ACTIONS)

1\.  Setup PNPM and restore Turbo remote cache  
2\.  \`pnpm exec turbo run lint typecheck\` – ESLint & \`tsc \--noEmit\`  
3\.  \`pnpm exec turbo run test\` – Vitest (Turbo skips untouched packages)  
4\.  \`pnpm exec turbo run build-storybook\` – generates static Storybook  
5\.  \`pnpm exec turbo run e2e\` – Playwright suite (headless)  
6\.  Deploy preview (Firebase Hosting channel \+ optional Storybook host)  
7\.  Changesets release & promote to prod on merge to \`main\`

\---

9\. ENVIRONMENTS & SECRETS

| Env | URL / target | Notes |  
| \--- | \--- | \--- |  
| local | localhost:5173 | .env \+ Firebase emulators; validated by T3 Env |  
| preview-\\\* | \`healthily-fit--pr-\*.web.app\` | Auto-created per PR on Firebase Hosting channel |  
| prod | \`https://healthily-fit.web.app\` | Promote via CI workflow on merge to \`main\` |

Secrets handled with \`firebase functions:config:set\` and GitHub repo secrets.

\---

10\. PERFORMANCE & SCALABILITY

\* Denormalize Firestore data where appropriate (e.g., store \`user.displayName\` on an \`activityLog\` if needed, though we will prioritize joins in tRPC logic first).  
\* Tune TanStack Query caching (\`staleTime\`, \`gcTime\`). Cache the global \`exercises\` collection on the client for a long duration (\`staleTime: 1\_000 \* 60 \* 60\`).  
\* Code-split via Vite dynamic imports (e.g., load the \`ProgressDashboard\` component dynamically).  
\* Monitor workout generation function (Gen 2\) for execution time and memory use, as this is the most compute-intensive operation.

\---

11\. CODE QUALITY & FORMATTING

\* Prettier formats on save / commit.  
\* ESLint governs rules; perfectionist plug-in auto-sorts imports and object keys.  
\`.

